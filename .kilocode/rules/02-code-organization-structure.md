# Code Organization and Structure

## Django Directory Structure

### Django App Conventions

```
jobs_manager/
â”œâ”€â”€ apps/                           # All Django apps
â”‚   â”œâ”€â”€ workflow/                   # Central app - base functionality
â”‚   â”‚   â”œâ”€â”€ models/                 # Models split by domain
â”‚   â”‚   â”œâ”€â”€ views/                  # Views organized by functionality
â”‚   â”‚   â”œâ”€â”€ services/               # Service layer for business logic
â”‚   â”‚   â”œâ”€â”€ api/                    # REST API endpoints
â”‚   â”‚   â”œâ”€â”€ management/commands/    # Custom Django commands
â”‚   â”‚   â””â”€â”€ migrations/             # Database migrations
â”‚   â”œâ”€â”€ job/                        # Job lifecycle management
â”‚   â”œâ”€â”€ accounts/                   # User management
â”‚   â”œâ”€â”€ client/                     # Client CRM
â”‚   â”œâ”€â”€ timesheet/                  # Time tracking
â”‚   â”œâ”€â”€ purchasing/                 # Purchase order management
â”‚   â”œâ”€â”€ accounting/                 # Financial reports
â”‚   â””â”€â”€ quoting/                    # Quotation generation
â”œâ”€â”€ jobs_manager/                   # Django settings
â”œâ”€â”€ docs/                           # Project documentation
â”œâ”€â”€ scripts/                        # Utility scripts
â””â”€â”€ stubs/                          # Type stubs for MyPy
```

### Individual App Organization

```
app_name/
â”œâ”€â”€ __init__.py                     # Auto-generated - DO NOT EDIT DIRECTLY
â”œâ”€â”€ models/                         # Models split by domain
â”‚   â”œâ”€â”€ __init__.py                 # Auto-generated - model imports
â”‚   â”œâ”€â”€ core.py                     # Core domain models
â”‚   â”œâ”€â”€ costing.py                  # Cost-related models
â”‚   â””â”€â”€ audit.py                    # Audit/history models
â”œâ”€â”€ views/                          # Views organized by type
â”‚   â”œâ”€â”€ __init__.py                 # Auto-generated
â”‚   â”œâ”€â”€ rest_views.py               # REST API views
â”‚   â”œâ”€â”€ template_views.py           # Django template-based views
â”‚   â””â”€â”€ ajax_views.py               # AJAX-specific views
â”œâ”€â”€ services/                       # Service layer
â”‚   â”œâ”€â”€ __init__.py                 # Auto-generated
â”‚   â”œâ”€â”€ business_service.py         # Main business logic
â”‚   â”œâ”€â”€ integration_service.py      # External integrations
â”‚   â””â”€â”€ data_service.py             # Complex data operations
â”œâ”€â”€ serializers/                    # DRF serializers
â”‚   â”œâ”€â”€ __init__.py                 # Auto-generated
â”‚   â”œâ”€â”€ api_serializers.py          # Main API serializers
â”‚   â””â”€â”€ nested_serializers.py       # Nested/specialized serializers
â”œâ”€â”€ api/                            # API configuration
â”‚   â”œâ”€â”€ __init__.py                 # Auto-generated
â”‚   â”œâ”€â”€ urls.py                     # API URLs
â”‚   â””â”€â”€ pagination.py               # Custom pagination classes
â”œâ”€â”€ management/                     # Django commands
â”‚   â””â”€â”€ commands/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ custom_command.py
â”œâ”€â”€ migrations/                     # Database migrations
â”œâ”€â”€ tests/                          # Tests
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test_models.py
â”‚   â”œâ”€â”€ test_services.py
â”‚   â”œâ”€â”€ test_api.py
â”‚   â””â”€â”€ fixtures/                   # Test data
â”œâ”€â”€ admin.py                        # Django Admin config
â”œâ”€â”€ apps.py                         # App config
â””â”€â”€ urls.py                         # Main app URLs
```

## ðŸš¨ CRITICAL RULE: Auto-generated __init__.py Files ðŸš¨

**NEVER edit __init__.py files directly** â€“ they are auto-generated. Run `python scripts/update_init.py` to regenerate them after adding/removing Python files.

### Example of Auto-generated __init__.py

```python
# This file is auto-generated by scripts/update_init.py
# DO NOT EDIT DIRECTLY

from .core import Job, JobEvent
from .costing import CostSet, CostLine
from .audit import JobHistory

__all__ = [
    'Job',
    'JobEvent',
    'CostSet',
    'CostLine',
    'JobHistory',
]
```

## Naming Conventions

### Files and Modules

```python
# Python files - snake_case
job_rest_service.py
cost_line_serializer.py
xero_integration_service.py

# Classes - PascalCase
class JobRestService:
class CostLineSerializer:
class XeroIntegrationService:

# Functions and methods - snake_case
def create_job():
def calculate_total_cost():
def sync_with_xero():

# Constants - UPPER_SNAKE_CASE
DEFAULT_CHARGE_OUT_RATE = 85.00
MAX_RETRY_ATTEMPTS = 3
XERO_API_BASE_URL = "https://api.xero.com"
```

### Django Models

```python
# Model names - singular PascalCase
class Job(models.Model):
class CostSet(models.Model):
class PurchaseOrder(models.Model):

# Model fields - snake_case
class Job(models.Model):
    job_number = models.CharField(max_length=20)
    created_at = models.DateTimeField(auto_now_add=True)
    charge_out_rate = models.DecimalField(max_digits=10, decimal_places=2)

    class Meta:
        db_table = "job_job"  # app_model format
        ordering = ["-created_at"]
        verbose_name = "Job"
        verbose_name_plural = "Jobs"
```

### URLs and Endpoints

```python
# URLs - kebab-case with versioning
urlpatterns = [
    path('api/v1/jobs/', JobListAPIView.as_view()),
    path('api/v1/jobs/<uuid:job_id>/', JobDetailAPIView.as_view()),
    path('api/v1/jobs/<uuid:job_id>/cost-sets/', CostSetListAPIView.as_view()),
    path('api/v1/purchase-orders/', PurchaseOrderListAPIView.as_view()),
]

# URL names - snake_case
urlpatterns = [
    path('jobs/', JobListView.as_view(), name='job_list'),
    path('jobs/<uuid:pk>/', JobDetailView.as_view(), name='job_detail'),
    path('jobs/<uuid:job_id>/edit/', JobEditView.as_view(), name='job_edit'),
]
```

## Model Organization

### Domain Split

```python
# models/core.py - Core domain models
class Job(models.Model):
    """Main model for jobs/projects."""
    pass

class Client(models.Model):
    """Client model."""
    pass

# models/costing.py - Cost-related models
class CostSet(models.Model):
    """Cost set for a job."""
    pass

class CostLine(models.Model):
    """Individual cost line."""
    pass

# models/audit.py - Audit models
class JobEvent(models.Model):
    """Audit events for jobs."""
    pass
```

### Model Patterns

```python
import uuid
from django.db import models
from simple_history.models import HistoricalRecords

class BaseModel(models.Model):
    """Base model with common fields."""
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        abstract = True

class Job(BaseModel):
    """Job model with auditing."""
    name = models.CharField(max_length=200)
    status = models.CharField(max_length=50, choices=STATUS_CHOICES)
    # SimpleHistory for auditing
    history = HistoricalRecords()
    class Meta:
        db_table = "job_job"
        ordering = ["-created_at"]
        indexes = [
            models.Index(fields=["status", "created_at"]),
            models.Index(fields=["client", "status"]),
        ]
```

## View Organization

### Split by Type

```python
# views/rest_views.py - REST API views
from rest_framework.viewsets import ModelViewSet
from rest_framework.decorators import action

class JobViewSet(ModelViewSet):
    """ViewSet for Job CRUD operations."""
    queryset = Job.objects.all()
    serializer_class = JobSerializer
    @action(detail=True, methods=['post'])
    def accept_quote(self, request, pk=None):
        """Accept quote for a job."""
        pass
```

## Service Organization

### Structured Service Layer

```python
# services/job_service.py - Main business logic
class JobService:
    """Service for Job business operations."""
    @staticmethod
    def create_job_with_estimate(job_data: dict, estimate_data: dict) -> Job:
        """Create job with initial estimate."""
        pass
    @staticmethod
    def calculate_job_profitability(job: Job) -> dict:
        """Calculate job profitability."""
        pass

# services/xero_service.py - External integration
class XeroService:
    """Service for Xero integration."""
    def sync_job_to_xero(self, job: Job) -> dict:
        """Sync job with Xero."""
        pass
```

## Configuration Management

### Settings Structure

```python
# jobs_manager/settings.py

# base.py - Shared settings
DJANGO_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    # ...
]

LOCAL_APPS = [
    'apps.workflow',
    'apps.job',
    'apps.accounts',
    # ...
]

THIRD_PARTY_APPS = [
    'rest_framework',
    'simple_history',
    # ...
]

INSTALLED_APPS = DJANGO_APPS + THIRD_PARTY_APPS + LOCAL_APPS
```

### Environment Variables

```python
# Use python-decouple for configuration
from decouple import config, Csv

# Required settings
DATABASE_URL = config('DATABASE_URL')
SECRET_KEY = config('SECRET_KEY')

# Optional settings with defaults
DEBUG = config('DEBUG', default=False, cast=bool)
ALLOWED_HOSTS = config('ALLOWED_HOSTS', default='localhost', cast=Csv())

# External integrations
XERO_CLIENT_ID = config('XERO_CLIENT_ID', default='')
DROPBOX_ACCESS_TOKEN = config('DROPBOX_ACCESS_TOKEN', default='')
```

## Dependency Management

### Poetry for Python

```toml
# pyproject.toml
[tool.poetry]
name = "jobs-manager"
version = "1.0.0"
description = "Job management system for Morris Sheetmetal"

[tool.poetry.dependencies]
python = "^3.12"
Django = "^5.0"
djangorestframework = "^3.14"
django-simple-history = "^3.4"

[tool.poetry.group.dev.dependencies]
black = "^23.0"
isort = "^5.12"
mypy = "^1.5"
pytest-django = "^4.5"

[tool.poetry.group.test.dependencies]
factory-boy = "^3.3"
pytest-cov = "^4.1"
```

### Version Control

```gitignore
# Project-specific .gitignore
*.pyc
__pycache__/
.env
.env.local
db.sqlite3
media/
staticfiles/
.coverage
htmlcov/
.pytest_cache/
.mypy_cache/
```

## Import Patterns

### Import Order

```python
# Standard Python imports
import os
import uuid
from datetime import datetime, date
from typing import Dict, List, Optional

# Django imports
from django.db import models, transaction
from django.shortcuts import get_object_or_404
from django.utils import timezone

# Third-party imports
from rest_framework import serializers, viewsets
from simple_history.models import HistoricalRecords

# Local imports
from apps.workflow.models import CompanyDefaults
from apps.job.models import Job, CostSet
from apps.job.services import JobService
```

### Relative Imports

```python
# Within the same app â€“ use relative imports
from .models import Job, CostSet
from .serializers import JobSerializer
from ..workflow.services import ErrorPersistenceService

# Between apps â€“ use absolute imports
from apps.client.models import Client
from apps.accounts.models import Staff
```

## Related References

- See: [01-architecture-design-patterns.md](./01-architecture-design-patterns.md)
- See: [03-api-design-standards.md](./03-api-design-standards.md)
- See: [07-testing-quality-assurance.md](./07-testing-quality-assurance.md)
