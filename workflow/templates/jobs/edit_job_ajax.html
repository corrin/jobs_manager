{% extends "base.html" %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/edit_job.css' %}">
    <link rel="stylesheet" href="{% static 'css/client_lookup.css' %}">
    <script src="{% static 'ag-grid-community/ag-grid-community.min.js' %}"></script>
{% endblock %}

{% block content %}
    <!-- Job Details Section -->
    {% include "jobs/edit_job_detail_section.html" %}

    <hr/>

    <div class="job-pricing-sections">
        <div class="job-grid-section">
            <h2>Estimate</h2>
            <div id="estimateTimeTable" class="ag-theme-alpine price-entry-table"></div>
            <div id="estimateMaterialsTable" class="ag-theme-alpine price-entry-table"></div>
            <div id="estimateAdjustmentsTable" class="ag-theme-alpine price-entry-table"></div>
            <button id="copyEstimateToQuote" class="btn btn-primary mt-3">Copy Estimate to Quote</button>
        </div>

        <div class="job-grid-section">
            <h2>Quote</h2>
            <div id="quoteTimeTable" class="ag-theme-alpine price-entry-table"></div>
            <div id="quoteMaterialsTable" class="ag-theme-alpine price-entry-table"></div>
            <div id="quoteAdjustmentsTable" class="ag-theme-alpine price-entry-table"></div>
            <button id="reviseQuote" class="btn btn-primary mt-3">Revise Quote</button>
            <button id="submitQuoteToClient" class="btn btn-primary mt-3">Submit Quote to Client</button>
        </div>

        <div class="job-grid-section">
            <h2>Reality</h2>
            <div id="realityTimeTable" class="ag-theme-alpine price-entry-table"><!-- Who populates this? --></div>
            <div id="realityMaterialsTable" class="ag-theme-alpine price-entry-table"></div>
            <div id="realityAdjustmentsTable" class="ag-theme-alpine price-entry-table"></div>
        </div>

        <div class="table-container">
            <div class="summary-table-section">
                <h2>Revenue</h2>
                <div id="revenueTable" class="ag-theme-alpine summary-grid"></div>
            </div>
            <div class="summary-table-section">
                <h2>Costs</h2>
                <div id="costsTable" class="ag-theme-alpine summary-grid"></div>
            </div>
        </div>
    </div>

<hr/>

    <!-- Attached Files Section -->
    <div class="job-files-section">
        <h2>Attached Files</h2>
        <div id="file-list">
            {% if job_files %}
                <div class="job-files-grid">
                    {% for file in job_files %}
                        <div class="file-card">
                            {% if file.thumbnail_path %}
                                <div class="thumbnail-container">
                                    <img src="{% url 'serve-job-file' file.thumbnail_path %}"
                                         alt="{{ file.filename }}"
                                         class="file-thumbnail">
                                </div>
                            {% else %}
                                <div class="thumbnail-container no-thumb">
                                    <span class="file-extension">{{ file.filename|filesizeformat }}</span>
                                </div>
                            {% endif %}
                            <div class="file-info">
                                <a href="{% url 'serve-job-file' file.file_path %}" target="_blank">
                                    {{ file.filename }}
                                </a>
                                <span class="timestamp">({{ file.uploaded_at|date:"Y-m-d H:i" }})</span>
                                <div class="file-actions">
                                    <label class="print-checkbox">
                                        <input type="checkbox" 
                                               class="autosave-input print-on-jobsheet" 
                                               name="jobfile_{{ file.id }}_print_on_jobsheet"
                                               {% if file.print_on_jobsheet %}checked{% endif %}>
                                        Print on Jobsheet
                                    </label>
                                    <button class="delete-file btn btn-sm btn-danger" 
                                            data-file-id="{{ file.id }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p>No files attached to this job.</p>
            {% endif %}
        </div>

        <div class="file-upload-area">
            <label for="file-input" class="file-drop-zone">
                <div class="drop-zone-text">
                    Drop files here or click to select files
                </div>
                <input type="file" id="file-input" multiple class="file-input">
            </label>
        </div>
    </div>

    <hr/>

    <!-- Workflow Section -->
    {% include "jobs/edit_job_workflow_section.html" %}

    <hr/>
    {% if job_form.errors %}
        <div class="alert alert-danger">
            <ul>
                {% for field, errors in job_form.errors.items %}
                    <li>{{ field }}: {{ errors }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    <hr/>

    <!-- Save/Cancel Buttons -->
    <div class="action-buttons">
        <button type="button" class="btn btn-secondary" id="printJobButton">Print Job</button>
        <button type="button" class="btn btn-secondary" id="printWorkshopButton">Print for Workshop</button>
        <button class="btn btn-primary" id="closeButton" onclick="window.location.href='/'">Close</button>
    </div>
{% endblock %}

{% block extra_js %}
    <!-- AG Grid -->
    <script src="{% static 'ag-grid-community/ag-grid-community.min.js' %}"></script>
    <!-- jsPDF -->
    <script src="{% static 'jspdf/jspdf.umd.min.js' %}"></script>
    <script src="{% static 'jspdf-autotable/jspdf.plugin.autotable.min.js' %}"></script>
    <!-- Custom JS -->
    <script type="application/json" id="latestJobPricingsData" style="display:none;">{{ latest_job_pricings_json|safe }}</script>
    <script type="application/json" id="historicalJobPricingsData" style="display:none;">{{ historical_job_pricings_json|safe }}</script>
    <script type="module" src="{% static 'js/deseralise_job_pricing.js' %}"></script>
    <script type="module" src="{% static 'js/edit_job_form_autosave.js' %}"></script>
    <script type="module" src="{% static 'js/job_file_handling.js' %}"></script>
    <script type="module" src="{% static 'js/client_lookup.js' %}"></script>
    <script type="module" src="{% static 'js/edit_job_grid_logic.js' %}"></script>
    <script type="module" src="{% static 'js/time_conversion.js' %}"></script>
{% endblock %}
